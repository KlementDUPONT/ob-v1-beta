schemaVersion: 2.2.0
metadata:
  name: game-addons-shop
  version: 1.0.0

components:
  # Container PHP pour le backend
  - name: php-backend
    container:
      image: registry.access.redhat.com/ubi8/php-81:latest
      memoryLimit: 1024Mi
      mountSources: true
      sourceMapping: /projects
      volumeMounts:
        - name: composer-cache
          path: /home/user/.composer
      endpoints:
        - name: backend-api
          targetPort: 8080
          exposure: public
          protocol: http
      env:
        - name: DOCUMENTROOT
          value: /projects/backend/public
        - name: PHP_MEMORY_LIMIT
          value: 512M

  # Container MySQL
  - name: mysql
    container:
      image: registry.access.redhat.com/rhel8/mysql-80:latest
      memoryLimit: 512Mi
      env:
        - name: MYSQL_ROOT_PASSWORD
          value: rootpass123
        - name: MYSQL_DATABASE
          value: game_addons_db
        - name: MYSQL_USER
          value: gameuser
        - name: MYSQL_PASSWORD
          value: gamepass123
      endpoints:
        - name: mysql
          targetPort: 3306
          exposure: internal
      volumeMounts:
        - name: mysql-storage
          path: /var/lib/mysql/data

  # Serveur web pour le frontend
  - name: frontend-server
    container:
      image: registry.access.redhat.com/ubi8/httpd-24:latest
      memoryLimit: 256Mi
      mountSources: true
      sourceMapping: /projects
      endpoints:
        - name: frontend
          targetPort: 8081
          exposure: public
          protocol: http
      env:
        - name: DOCUMENTROOT
          value: /projects/frontend

  # Volume pour le cache Composer
  - name: composer-cache
    volume:
      size: 1Gi

  # Volume pour MySQL
  - name: mysql-storage
    volume:
      size: 2Gi

commands:
  # Commandes pour le backend
  - id: install-backend-deps
    exec:
      component: php-backend
      commandLine: cd /projects/backend && composer install
      workingDir: /projects/backend
      group:
        kind: build

  - id: start-backend
    exec:
      component: php-backend
      commandLine: php -S 0.0.0.0:8080 -t /projects/backend/public
      workingDir: /projects/backend
      group:
        kind: run
        isDefault: true

  # Commandes pour la base de données
  - id: init-database
    exec:
      component: mysql
      commandLine: mysql -u gameuser -pgamepass123 game_addons_db < /projects/database/schema.sql
      workingDir: /projects
      group:
        kind: build

  # Commande pour le frontend
  - id: start-frontend
    exec:
      component: frontend-server
      commandLine: httpd -D FOREGROUND
      workingDir: /projects/frontend
      group:
        kind: run

events:
  postStart:
    - install-backend-deps
